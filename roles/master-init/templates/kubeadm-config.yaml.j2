apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: v{{ k8s_version }}
imageRepository: registry.aliyuncs.com/google_containers
controlPlaneEndpoint: "{{ hostvars[groups['masters'][0]]['ansible_host'] }}:{{ kube_apiserver_port }}"
networking:
  podSubnet: "{{ kubernetes_pod_subnet }}"
  serviceSubnet: "{{ kubernetes_service_subnet }}"
apiServer:
  certSANs:
{% for host in groups['masters'] %}
    - {{ hostvars[host]['ansible_host'] }}
    - {{ host }}
{% endfor %}
    - 127.0.0.1
    - localhost
  extraArgs:
    bind-address: "0.0.0.0"
controllerManager:
  extraArgs:
    bind-address: "0.0.0.0"
scheduler:
  extraArgs:
    bind-address: "0.0.0.0"
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
nodeRegistration:
  criSocket: unix:///run/containerd/containerd.sock
  kubeletExtraArgs:
    cgroup-driver: systemd
    node-ip: "{{ ansible_host }}"
    hostname-override: "{{ inventory_hostname }}"
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: JoinConfiguration
nodeRegistration:
  criSocket: unix:///run/containerd/containerd.sock
  kubeletExtraArgs:
    cgroup-driver: systemd
    node-ip: "{{ ansible_host }}"
    hostname-override: "{{ inventory_hostname }}"

---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
serverTLSBootstrap: true
